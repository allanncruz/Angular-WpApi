# Angular WpApi

This project was generated with [Angular CLI](https://github.com/angular/angular-cli) version 6.2.3.

## Development server

Run `npm start ` for a dev server. Navigate to `http://localhost:4200/`. The app will automatically reload if you change any of the source files.

## Build

Run `ng build` to build the project. The build artifacts will be stored in the `dist/` directory. Use the `--prod` flag for a production build.

## Default functions

#### Functions for send system
```
function sendWithPhpMailer($subject, $body, $emailAttachment, $reply) {
    require(ABSPATH . WPINC . '/class-phpmailer.php');
    require(ABSPATH . WPINC . '/class-smtp.php');
    // date_default_timezone_set( 'America/Sao_Paulo' );
    $blogname = wp_strip_all_tags( trim( get_option( 'blogname' ) ) );
//     $smtpHost = wp_strip_all_tags( trim( get_option( 'smtp_host' ) ) );
//     $mailPort = wp_strip_all_tags( trim( get_option( 'smtp_port' ) ) );
//     $smtpUser = wp_strip_all_tags( trim( get_option( 'smtp_user' ) ) );
//     $smtpPass = wp_strip_all_tags( trim( get_option( 'smtp_pass' ) ) );
//     $mailTo = wp_strip_all_tags( trim( get_option( 'mail_to' ) ) );
    $mailFrom = 'contato@meggasolar.com.br';
    $mailTo =['eduardo@meggasolar.com.br','max@meggasolar.com.br','thaiza@meggasolar.com.br','administrativo@meggasolar.com.br', $reply];
	$mailInterativa = [''];
    $send = false;
    $mail = new PHPMailer;
    try {
// 		   <--- SMTP --->
//         $mail->IsSMTP();
//         $mail->SMTPDebug = 0;
//         $mail->Sender = $smtpUser;
//         $mail->SMTPSecure = 'tls';
//         $mail->SMTPAuth = true;
//         $mail->Port = $mailPort;
//         $mail->Host = $smtpHost;
//         $mail->Username = $smtpUser;
//         $mail->Password = $smtpPass;

		$mail->From = $mailFrom;
		$mail->FromName = $blogname;
        $mail->setFrom($mailFrom, $blogname);
        $mail->CharSet = 'utf-8';
        $mail->Subject = $subject;
        $mail->addReplyTo($reply);
		foreach($mailTo as $value) {
			$mail->addAddress($value);
		}
		foreach($mailInterativa as $value) {
			$mail->addBCC($value);
		}

		$uploadedfile = $emailAttachment;		
		
		$image = base64_decode(preg_replace('#^data:image/\w+;base64,#i', '', $uploadedfile));
		$upload_dir = wp_upload_dir();

		// @new
		$upload_path = str_replace( '/', DIRECTORY_SEPARATOR, $upload_dir['path'] ) . DIRECTORY_SEPARATOR;

		$decoded = $image;
		$filename = 'attachment.jpg';

		$hashed_filename = md5( $filename . microtime() ) . '_' . $filename;

		// @new
		$image_upload = file_put_contents( $upload_path . $hashed_filename, $decoded );

		//HANDLE UPLOADED FILE
		if( !function_exists( 'wp_handle_sideload' ) ) {
		  require_once( ABSPATH . 'wp-admin/includes/file.php' );
		}

		// Without that I'm getting a debug error!?
		if( !function_exists( 'wp_get_current_user' ) ) {
		  require_once( ABSPATH . 'wp-includes/pluggable.php' );
		}

		// @new
		$file             = array();
		$file['error']    = '';
		$file['tmp_name'] = $upload_path . $hashed_filename;
		$file['name']     = $hashed_filename;
		$file['type']     = 'image/jpeg';
		$file['size']     = filesize( $upload_path . $hashed_filename );

		// upload file to server
		// @new use $file instead of $image_upload
		$file_return = wp_handle_sideload( $file, array( 'test_form' => false ) );

		$filepath = $file_return['file'];
		$filename = end(explode("/", $filepath));

		if ( $file_return && ! isset( $file_return['error'] ) ) {
			
			// Attachments
			$mail->addAttachment($filepath, $filename);
// 			$mail->addStringAttachment(file_get_contents($file_return['url']), '2_'.$filename);
		} else {
			/**
			 * Error generated by _wp_handle_upload()
			 * @see _wp_handle_upload() in wp-admin/includes/file.php
			 */
// 			$file_return['error'];
		}
		
        $mail->isHTML(true);
        $mail->Body = $body;
        $send = $mail->send();
        $mail->ClearAllRecipients();
		return ['sended' => $send];
    } catch (Exception $e) {
        echo "Message could not be sent. Mailer Error: $mail->ErrorInfo \n";
        echo "Error: $e";
        return ['sended' => false, 'error' => $mail->ErrorInfo];
    }
	
    return ['sended' => $send];
}

function sendContactMail(WP_REST_Request $request) {
    $response = array(
        'status' => 304,
        'message' => 'There was an error sending the form.'
    );
    $parameters = $request->get_json_params();
    if ( count($_POST) > 0 ) {
        $parameters = $_POST;
    }
	
	$emailAttachment = wp_strip_all_tags( trim( $parameters['file'] ) );
	
	$emailType = wp_strip_all_tags( trim( $parameters['tipo_email'] ) );
	
    $contactName = wp_strip_all_tags( trim( $parameters['nome'] ) );
    $contactEmail = wp_strip_all_tags( trim( $parameters['email'] ) );
    $contactPhone = wp_strip_all_tags( trim( $parameters['telefone'] ) );
    $contactUnidade = wp_strip_all_tags( trim( $parameters['unidade'] ) );
	$contactCpf = wp_strip_all_tags( trim( $parameters['cpf'] ) );
	$contactEstadoCivil = wp_strip_all_tags( trim( $parameters['estado-civil'] ) );
	$contactCidadeAtuacao = wp_strip_all_tags( trim( $parameters['cidade-atuacao'] ) );
	$contactCidadeInvestimento = wp_strip_all_tags( trim( $parameters['investimento'] ) );
	
	$contactLojaLicenciada = wp_strip_all_tags( trim( $parameters['loja-licenciada'] ) );
	$contactComoConheceu = wp_strip_all_tags( trim( $parameters['como-conheceu'] ) );
	$contactRamo = wp_strip_all_tags( trim( $parameters['ramo'] ) );
	$contactRenda = wp_strip_all_tags( trim( $parameters['renda'] ) );
	
    $contactMessage = wp_strip_all_tags( trim( $parameters['mensagem'] ) );
    if ( !empty($contactName) && !empty($contactEmail) && !empty($contactPhone) ) {
		$blogname = wp_strip_all_tags( trim( get_option( 'blogname' ) ) );
		
		$body = "<h3>$subject</h3><br/>";
        $body .= "<p><b>Nome:</b> $contactName</p>";
        $body .= "<p><b>Email:</b> $contactEmail</p>";
        $body .= "<p><b>Telefone:</b> $contactPhone</p>";
		
		$subject = "(Novo contato via $blogname) $contactName <$contactEmail>";
		if ($emailType == 'onde_atuamos') {
			$subject = "(Novo contato via $blogname - Onde Atuamos) $contactName <$contactEmail>";
			$body .= "<p><b>Unidade:</b> $contactUnidade</p>";
			$body .= "<p><b>Mensagem:</b> $contactMessage</p>"; 
		}
		if ($emailType == 'contato') {
			$subject = "(Novo contato via $blogname - Contato) $contactName <$contactEmail>";
			$body .= "<p><b>Unidade:</b> $contactUnidade</p>";
			$body .= "<p><b>Mensagem:</b> $contactMessage</p>"; 
		}
		if ($emailType == 'orcamento') {
			$subject = "(Novo contato via $blogname - Orcamento) $contactName <$contactEmail>";
			$body .= "<p><b>Conta de energia:</b> $contactContaEnergia</p>"; 
		}
		
		if ($emailType == 'parceiros') {
			$subject = "(Novo contato via $blogname - Parceiros) $contactName <$contactEmail>";
			$body .= "<p><b>Cpf:</b> $contactCpf</p>";
			$body .= "<p><b>Estado Civil:</b> $contactEstadoCivil</p>";
			$body .= "<p><b>Cidade onde pretende atuar:</b> $contactCidadeAtuacao</p>";
			$body .= "<p><b>Capital de Investimento:</b> $contactCidadeInvestimento</p>";
			$body .= "<p><b>Quando pretende abrir a loja licenciada:</b> $contactLojaLicenciada</p>";
			$body .= "<p><b>Conheceu a empresa:</b> $contactComoConheceu</p>";
			$body .= "<p><b>Ramo:</b> $contactRamo</p>";
			$body .= "<p><b>Renda:</b> $contactRenda</p>";
		}
		
             
		
		$sendAction = sendWithPhpMailer( $subject, $body, $emailAttachment, $contactEmail );
        if ( $sendAction ) {
            $response['status'] = 200;
            $response['message'] = 'Form sent successfully.';
            $response['sended'] = $sendAction->sended;
        } else {
			$response['error'] = $sendAction->error;
		}
    }
	
    return json_decode( json_encode( $response ) );
    exit();
}
add_action( 'rest_api_init', function () {
    register_rest_route( 'wp/v2/contact', '/send', array(
        'methods' => 'POST',
        'callback' => 'sendContactMail'
    ));
});
```
#### Add post type
```
function regiaoType()
    {
        $labels = array(
            'name'               => 'Regiões',
            'singular_name'      => 'Região',
            'menu_name'          => 'Regiões',
            'name_admin_bar'     => 'Regiões',
            'add_new'            => 'Adicionar Novo',
            'add_new_item'       => 'Adicionar novo item',
            'new_item'           => 'Novo Item',
            'edit_item'          => 'Editar Item',
            'view_item'          => 'Ver Item',
            'all_items'          => 'Todos os Itens',
            'search_items'       => 'Procurar Região',
            'parent_item_colon'  => 'Parent Região',
            'not_found'          => 'Nenhum item encontrado',
            'not_found_in_trash' => 'Nenhum item encontrado na lixeira'
        );

        $args = array(
            'labels'             => $labels,
            'description'        => 'Todos os itens',
            'public'             => true,
            'show_in_rest'       => true,
            'publicly_queryable' => true,
            'show_ui'            => true,
            'show_in_menu'       => true,
            'menu_icon'          => 'dashicons-location-alt',
            'query_var'          => true,
            'rewrite'            => array( 'slug' => 'regioes' ),
            'capability_type'    => 'post',
            'has_archive'        => true,
            'hierarchical'       => true,
            'menu_position'      => null,
            'rest_base'          => 'regioes',
            'rest_controller_class' => 'WP_REST_Posts_Controller',
            'supports'           => array( 'title', 'editor','thumbnail')
        );

        register_post_type( 'regiao', $args );

        flush_rewrite_rules();
    }
    add_action('init', 'regiaoType');
```
